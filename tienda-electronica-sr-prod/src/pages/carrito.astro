---
import BaseLayout from "../layouts/BaseLayout.astro";
const base = import.meta.env.BASE_URL;
const href = (p: string) => `${base}${p.replace(/^\//, "")}`;
---
<BaseLayout title="Carrito | Tienda Electrónica SR">
  <h1 class="text-xl font-semibold">Tu carrito</h1>

  <div id="empty" class="mt-6 hidden rounded-lg border border-slate-200 p-6 text-slate-600">
    El carrito está vacío. <a class="underline" href={href("/catalogo")}>Ir al catálogo</a>.
  </div>

  <div class="mt-6 grid gap-6 md:grid-cols-3">
    <section class="md:col-span-2">
      <div id="items" class="space-y-3"></div>
    </section>

    <aside class="rounded-lg border border-slate-200 p-4">
      <div class="flex items-center justify-between text-sm">
        <span class="text-slate-600">Subtotal</span>
        <span id="subtotal" class="font-semibold"></span>
      </div>
      <div class="mt-2 text-xs text-slate-500">El envío se calcula en checkout.</div>

      <a id="goCheckout" class="mt-4 block rounded-md bg-slate-900 px-4 py-2 text-center text-sm font-medium text-white hover:bg-slate-800" href={href("/checkout")}>
        Finalizar compra
      </a>
    </aside>
  </div>

  <script type="module">
    import { getCart, updateQty, removeItem } from "../lib/cart";
    import { PRODUCTS } from "../data/products";
    import { formatMoney } from "../lib/format";

    const itemsEl = document.getElementById("items");
    const emptyEl = document.getElementById("empty");
    const subtotalEl = document.getElementById("subtotal");
    const goCheckout = document.getElementById("goCheckout");

    function render() {
      const cart = getCart();
      const map = new Map(PRODUCTS.map(p => [p.id, p]));
      const lines = cart.items
        .map(i => {
          const p = map.get(i.productId);
          if (!p) return null;
          const max = p.stockQty;
          const qty = Math.min(i.qty, max);
          const lineTotal = p.price * qty;
          return { p, qty, max, lineTotal };
        })
        .filter(Boolean);

      if (!lines.length) {
        if (emptyEl) emptyEl.classList.remove("hidden");
        if (itemsEl) itemsEl.innerHTML = "";
        if (subtotalEl) subtotalEl.textContent = formatMoney(0, "UYU");
        if (goCheckout) goCheckout.classList.add("pointer-events-none", "opacity-50");
        return;
      }

      if (emptyEl) emptyEl.classList.add("hidden");
      if (goCheckout) goCheckout.classList.remove("pointer-events-none", "opacity-50");

      let subtotal = 0;
      itemsEl.innerHTML = "";
      for (const line of lines) {
        subtotal += line.lineTotal;

        const row = document.createElement("div");
        row.className = "rounded-lg border border-slate-200 p-4";

        row.innerHTML = `
          <div class="flex gap-4">
            <img class="h-20 w-20 rounded-md object-cover border border-slate-200" src="${line.p.images[0]}" alt="${line.p.name}" />
            <div class="flex-1">
              <div class="font-medium">${line.p.name}</div>
              <div class="text-sm text-slate-600">${line.p.sku} · ${line.p.brand}</div>
              <div class="mt-2 flex flex-wrap items-center gap-3">
                <label class="text-sm">
                  Cantidad
                  <input data-qty="${line.p.id}" type="number" min="1" max="${line.max}" value="${line.qty}"
                    class="ml-2 w-24 rounded-md border border-slate-200 px-3 py-2" />
                </label>
                <button data-remove="${line.p.id}" class="text-sm underline text-slate-700">Eliminar</button>
              </div>
            </div>
            <div class="text-right font-semibold">${formatMoney(line.p.price * line.qty, line.p.currency)}</div>
          </div>
          ${line.max <= 0 ? `<div class="mt-2 text-sm text-slate-600">Sin stock: este ítem se ajustará al confirmar.</div>` : ""}
        `;
        itemsEl.appendChild(row);
      }

      subtotalEl.textContent = formatMoney(subtotal, "UYU");

      itemsEl.querySelectorAll("input[data-qty]").forEach((inp) => {
        inp.addEventListener("change", (e) => {
          const el = e.currentTarget;
          const id = el.getAttribute("data-qty");
          const v = Math.max(1, Number(el.value || 1));
          const p = map.get(id);
          if (!p) return;
          const safe = Math.min(v, p.stockQty || 1);
          el.value = String(safe);
          updateQty(id, safe);
          render();
        });
      });

      itemsEl.querySelectorAll("button[data-remove]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-remove");
          removeItem(id);
          render();
        });
      });
    }

    render();
    window.addEventListener("cart:updated", render);
  </script>
</BaseLayout>
