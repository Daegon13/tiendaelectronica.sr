---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getAllProducts, getProductBySlug } from "../../lib/products";
import { formatMoney } from "../../lib/format";

export async function getStaticPaths() {
  const products = getAllProducts();
  return products.map(p => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const product = slug ? getProductBySlug(slug) : undefined;

const base = import.meta.env.BASE_URL;
const href = (p: string) => `${base}${p.replace(/^\//, "")}`;

if (!product) {
  throw new Error("Producto no encontrado");
}
---
<BaseLayout title={`${product.name} | Tienda Electrónica SR`}>
  <div class="grid gap-8 md:grid-cols-2">
    <div>
      <img class="w-full rounded-xl border border-slate-200 object-cover" src={product.images[0]} alt={product.name} />
      <div class="mt-3 grid grid-cols-3 gap-3">
        {product.images.slice(0, 3).map(img => (
          <img class="h-24 w-full rounded-lg border border-slate-200 object-cover" src={img} alt="" loading="lazy" />
        ))}
      </div>
    </div>

    <div>
      <a class="text-sm underline text-slate-600" href={href("/catalogo")}>Volver al catálogo</a>
      <h1 class="mt-2 text-2xl font-semibold">{product.name}</h1>
      <div class="mt-1 text-slate-600">{product.brand} · {product.category}</div>

      <div class="mt-4 text-2xl font-semibold">{formatMoney(product.price, product.currency)}</div>

      <div class="mt-3">
        <span class={`text-xs px-2 py-1 rounded-full ${product.stockQty <= 0 ? "bg-slate-100 text-slate-600" : "bg-emerald-50 text-emerald-700"}`}>
          {product.stockQty <= 0 ? "Sin stock" : `Stock: ${product.stockQty}`}
        </span>
      </div>

      <p class="mt-4 text-slate-700">{product.shortDescription}</p>

      <div class="mt-5 flex items-center gap-3">
        <label class="text-sm">
          Cantidad
          <input id="qty" type="number" min="1" value="1" class="mt-1 w-24 rounded-md border border-slate-200 px-3 py-2" />
        </label>

        <button
          id="add"
          class={`mt-6 rounded-md px-4 py-2 text-sm font-medium ${product.stockQty <= 0 ? "bg-slate-200 text-slate-500 cursor-not-allowed" : "bg-slate-900 text-white hover:bg-slate-800"}`}
          disabled={product.stockQty <= 0}
          data-product-id={product.id}
          data-stock={product.stockQty}
        >
          Agregar al carrito
        </button>
      </div>

      <div id="msg" class="mt-3 text-sm text-slate-600"></div>

      <div class="mt-8">
        <h2 class="font-semibold">Especificaciones</h2>
        <div class="mt-3 rounded-lg border border-slate-200">
          <table class="w-full text-sm">
            <tbody>
              {Object.entries(product.specs).map(([k, v]) => (
                <tr class="border-t border-slate-200">
                  <td class="w-1/3 px-4 py-3 font-medium">{k}</td>
                  <td class="px-4 py-3 text-slate-700">{v}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div class="mt-4 text-sm text-slate-600">
          Garantía y devoluciones: <a class="underline" href={href("/legal/devoluciones")}>ver políticas</a>.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { addItem } from "../../lib/cart";
    import { PRODUCTS } from "../../data/products";

    const btn = document.getElementById("add");
    const qtyEl = document.getElementById("qty");
    const msg = document.getElementById("msg");

    const productId = btn?.dataset.productId;
    const stock = Number(btn?.dataset.stock || "0");

    function show(text) { if (msg) msg.textContent = text; }

    btn?.addEventListener("click", () => {
      if (!productId) return;

      const qty = Math.max(1, Number(qtyEl?.value || 1));
      const prod = PRODUCTS.find(p => p.id === productId);
      if (!prod) return;

      if (qty > stock) {
        show(`No se puede agregar esa cantidad. Stock disponible: ${stock}.`);
        return;
      }

      addItem(productId, qty);
      show("Producto agregado al carrito.");
    });
  </script>
</BaseLayout>
